services:
  redis:
    image: redis:7-alpine
    container_name: mobox-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - mobox-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:16-alpine
    container_name: mobox-postgres
    environment:
      POSTGRES_DB: mobox
      POSTGRES_USER: mobox
      POSTGRES_PASSWORD: mobox
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mobox"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - mobox-network
    restart: unless-stopped

  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:1.35.3
    container_name: mobox-weaviate
    ports:
      - "9000:8080"
      - "50051:50051"
    volumes:
      - weaviate_data:/var/lib/weaviate
    environment:
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - CLUSTER_HOSTNAME=node1
      - ENABLE_MODULES=text2vec-transformers
      - TRANSFORMERS_INFERENCE_API=http://text2vec-transformers:8080
    depends_on:
      - text2vec-transformers
    restart: unless-stopped
    networks:
      - mobox-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/v1/meta"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  text2vec-transformers:
    image: cr.weaviate.io/semitechnologies/transformers-inference:sentence-transformers-multi-qa-MiniLM-L6-cos-v1
    container_name: mobox-text2vec-transformers
    environment:
      - ENABLE_CUDA=0  # Set to 1 to enable GPU acceleration
    restart: unless-stopped
    networks:
      - mobox-network

  dagster:
    build:
      context: data
      dockerfile: Dockerfile
    container_name: mobox-dagster
    ports:
      - "3000:3000"
    volumes:
      # Mount features directory so PDFs are accessible
      - ./data/features:/app/features:ro
      # Mount source code (use :ro for read-only in production)
      - ./data/src:/app/src:ro
      # Mount workspace.yaml for Dagster configuration
      - ./data/workspace.yaml:/app/workspace.yaml:ro
      # Persist Dagster home directory
      - dagster_home:/app/.dagster_home
    environment:
      - WEAVIATE_HOST=weaviate
      - WEAVIATE_PORT=8080
      - WEAVIATE_GRPC_PORT=50051
      - DAGSTER_HOME=/app/.dagster_home
      - PYTHONPATH=/app/src
    depends_on:
      weaviate:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - mobox-network
    command: ["dagster", "dev", "-h", "0.0.0.0", "-p", "3000", "-w", "workspace.yaml"]

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: mobox-api
    ports:
      - "8080:8080"
    environment:
      # Server Configuration
      - PORT=8080
      - HOST=0.0.0.0
      - ENVIRONMENT=local
      # PostgreSQL Configuration
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=mobox
      - POSTGRES_USER=mobox
      - POSTGRES_PASSWORD=mobox
      # Modal Configuration (for sandbox execution)
      - MODAL_TOKEN_ID=${MODAL_TOKEN_ID:-}
      - MODAL_TOKEN_SECRET=${MODAL_TOKEN_SECRET:-}
      # Anthropic API key (passed to agents)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # OpenAI API key (passed to agents)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Tavily API key (passed to agents)
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - mobox-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  weaviate_data:
    driver: local
  dagster_home:
    driver: local

networks:
  mobox-network:
    driver: bridge
